---
- name: Configureer Systeem en Installeer Tools
  hosts: demo-1
  become: yes
  vars:
    ntfy_server_url: "https://ntfy.dinandserver.duckdns.org/phone"
    required_packages:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    docker_packages:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
    ssh_service: ssh

  tasks:
    - name: ⏳ Verstuur Notificatie - Start Installatie
      ansible.builtin.uri:
        url: "{{ ntfy_server_url }}"
        method: POST
        headers:
          Title: "Start Installatie"
        body: "Installatie begint op {{ ansible_hostname }}"
        body_format: raw
      run_once: true

    - name: 🔄 Update apt package cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: 📦 Installeer vereiste pakketten
      ansible.builtin.apt:
        name: "{{ required_packages }}"
        state: present

    - name: 🐳 Installeer Docker pakketten
      ansible.builtin.apt:
        name: "{{ docker_packages }}"
        state: present

    - name: 📜 Pas sshd_config aan
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^{{ item.regex }}'
        line: "{{ item.line }}"
        state: present
        backup: yes
      loop:
        - { regex: '#?PermitRootLogin .*', line: 'PermitRootLogin yes' }
        - { regex: '#?PasswordAuthentication .*', line: 'PasswordAuthentication yes' }

    - name: 🔄 Herstart SSH-service
      ansible.builtin.service:
        name: "{{ ssh_service }}"
        state: restarted
        enabled: yes

    - name: ✅ Notificatie - SSH Configuratie Voltooid
      ansible.builtin.uri:
        url: "{{ ntfy_server_url }}"
        method: POST
        headers:
          Title: "SSH Install"
        body: "SSH configuratie voltooid op {{ ansible_hostname }}"
        body_format: raw
      run_once: true